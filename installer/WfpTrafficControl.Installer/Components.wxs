<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

  <!--
    Component definitions for WfpTrafficControl files.

    Components are the atomic unit of installation in Windows Installer.
    Each component should contain related files that are always installed/uninstalled together.

    IMPORTANT: Component GUIDs must remain stable across versions for proper upgrade behavior.

    NOTE: Service executable is defined in ServiceInstall.wxs with ServiceInstall/ServiceControl elements.

    Uses BindPaths defined in .wixproj:
      - ServicePublish: Service publish directory
      - CliPublish: CLI publish directory
      - Scripts: Scripts directory
  -->

  <Fragment>
    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">

      <!-- Service configuration file -->
      <Component Id="ServiceConfig" Guid="B2C3D4E5-F6A7-4B5C-9D0E-1F2A3B4C5D6E">
        <File Id="AppSettingsJson"
              Source="!(bindpath.ServicePublish)\appsettings.json"
              KeyPath="yes" />
      </Component>

      <!-- Shared library -->
      <Component Id="SharedLibrary" Guid="C3D4E5F6-A7B8-4C5D-0E1F-2A3B4C5D6E7F">
        <File Id="SharedDll"
              Source="!(bindpath.ServicePublish)\Shared.dll"
              KeyPath="yes" />
      </Component>

      <!-- Service runtime configuration -->
      <Component Id="ServiceRuntimeConfig" Guid="D4E5F6A7-B8C9-4D5E-1F2A-3B4C5D6E7F8A">
        <File Id="ServiceDepsJson"
              Source="!(bindpath.ServicePublish)\WfpTrafficControl.Service.deps.json"
              KeyPath="yes" />
        <File Id="ServiceRuntimeConfigJson"
              Source="!(bindpath.ServicePublish)\WfpTrafficControl.Service.runtimeconfig.json" />
      </Component>

    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="CliComponents" Directory="INSTALLFOLDER">

      <!-- CLI executable -->
      <Component Id="CliExecutable" Guid="E5F6A7B8-C9D0-4E5F-2A3B-4C5D6E7F8A9B">
        <File Id="WfpctlExe"
              Source="!(bindpath.CliPublish)\wfpctl.exe"
              KeyPath="yes" />
      </Component>

      <!-- CLI runtime configuration -->
      <Component Id="CliRuntimeConfig" Guid="F6A7B8C9-D0E1-4F5A-3B4C-5D6E7F8A9B0C">
        <File Id="CliDepsJson"
              Source="!(bindpath.CliPublish)\wfpctl.deps.json"
              KeyPath="yes" />
        <File Id="CliRuntimeConfigJson"
              Source="!(bindpath.CliPublish)\wfpctl.runtimeconfig.json" />
      </Component>

    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="SampleComponents" Directory="INSTALLFOLDER">

      <!-- Sample policy file for reference -->
      <Component Id="SamplePolicy" Guid="A7B8C9D0-E1F2-4A5B-4C5D-6E7F8A9B0C1D">
        <File Id="SamplePolicyJson"
              Source="!(bindpath.Scripts)\sample-demo-policy.json"
              Name="sample-policy.json"
              KeyPath="yes" />
      </Component>

    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="PathComponents" Directory="INSTALLFOLDER">

      <!-- Add installation directory to system PATH -->
      <Component Id="PathEntry" Guid="B8C9D0E1-F2A3-4B5C-5D6E-7F8A9B0C1D2E" KeyPath="yes">
        <Environment Id="PATH"
                     Name="PATH"
                     Value="[INSTALLFOLDER]"
                     Permanent="no"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>

    </ComponentGroup>
  </Fragment>

</Wix>
