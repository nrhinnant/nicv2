<UserControl x:Class="WfpTrafficControl.UI.Views.LogsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:WfpTrafficControl.UI.ViewModels"
             xmlns:converters="clr-namespace:WfpTrafficControl.UI.Converters"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=vm:LogsViewModel}"
             d:DesignHeight="600" d:DesignWidth="1000"
             Background="{DynamicResource BackgroundBrush}">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility" />
        <converters:InverseBoolConverter x:Key="InverseBool" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <!-- Toolbar -->
            <RowDefinition Height="Auto" />
            <!-- Content -->
            <RowDefinition Height="*" />
            <!-- Status Bar -->
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Filter Options -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <RadioButton Content="Last N entries"
                                 IsChecked="{Binding UseTailFilter}"
                                 VerticalAlignment="Center"
                                 Margin="0,0,8,0" />
                    <TextBox Text="{Binding TailCount, UpdateSourceTrigger=PropertyChanged}"
                             Width="60"
                             VerticalAlignment="Center"
                             IsEnabled="{Binding UseTailFilter}"
                             Margin="0,0,24,0" />

                    <RadioButton Content="Since (minutes)"
                                 IsChecked="{Binding UseTailFilter, Converter={StaticResource InverseBool}}"
                                 VerticalAlignment="Center"
                                 Margin="0,0,8,0" />
                    <TextBox Text="{Binding SinceMinutes, UpdateSourceTrigger=PropertyChanged}"
                             Width="60"
                             VerticalAlignment="Center"
                             IsEnabled="{Binding UseTailFilter, Converter={StaticResource InverseBool}}"
                             Margin="0,0,16,0" />
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="Refresh"
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding RefreshLogsCommand}"
                            Padding="16,6"
                            Margin="0,0,8,0" />

                    <Button Content="Clear Filter"
                            Style="{StaticResource SecondaryButtonStyle}"
                            Command="{Binding ClearFilterCommand}"
                            Padding="12,6"
                            Margin="0,0,8,0" />
                </StackPanel>

                <!-- Export Button -->
                <Button Grid.Column="3"
                        Content="Export to CSV"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Command="{Binding ExportToCsvCommand}"
                        Padding="12,6" />
            </Grid>
        </Border>

        <!-- Log Entries Grid -->
        <Border Grid.Row="1" Margin="16" Style="{StaticResource CardStyle}" Padding="0">
            <Grid>
                <DataGrid ItemsSource="{Binding LogEntries}"
                          SelectedItem="{Binding SelectedEntry}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          HeadersVisibility="Column"
                          GridLinesVisibility="Horizontal"
                          BorderThickness="0"
                          Background="Transparent"
                          RowBackground="{DynamicResource CardBackgroundBrush}"
                          AlternatingRowBackground="#FAFAFA"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          CanUserResizeRows="False"
                          SelectionMode="Single"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          EnableRowVirtualization="True">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Timestamp"
                                            Binding="{Binding Timestamp}"
                                            Width="180" />
                        <DataGridTextColumn Header="Event"
                                            Binding="{Binding Event}"
                                            Width="140" />
                        <DataGridTextColumn Header="Source"
                                            Binding="{Binding Source}"
                                            Width="100" />
                        <DataGridTextColumn Header="Status"
                                            Binding="{Binding Status}"
                                            Width="80">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Status}" Value="success">
                                            <Setter Property="Foreground" Value="{DynamicResource SuccessBrush}" />
                                            <Setter Property="FontWeight" Value="SemiBold" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="failure">
                                            <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}" />
                                            <Setter Property="FontWeight" Value="SemiBold" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Policy"
                                            Binding="{Binding PolicyVersion}"
                                            Width="100" />
                        <DataGridTextColumn Header="Created"
                                            Binding="{Binding FiltersCreated}"
                                            Width="70" />
                        <DataGridTextColumn Header="Removed"
                                            Binding="{Binding FiltersRemoved}"
                                            Width="70" />
                        <DataGridTextColumn Header="Error"
                                            Binding="{Binding ErrorMessage}"
                                            Width="*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}" />
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                                    <Setter Property="ToolTip" Value="{Binding ErrorMessage}" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Empty State -->
                <TextBlock Text="No log entries found. Click Refresh to load logs."
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="14">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding LogEntries.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- Loading Overlay -->
                <Border Background="#80FFFFFF"
                        Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
                    <TextBlock Text="Loading logs..."
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               FontSize="16"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                </Border>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="2"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Status Message -->
                <TextBlock Grid.Column="0"
                           Text="{Binding StatusMessage}"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextSecondaryBrush}" />

                <!-- Log File Path -->
                <TextBlock Grid.Column="1"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="11">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding LogFilePath}" Value="">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                    <Run Text="Log file: " />
                    <Run Text="{Binding LogFilePath, Mode=OneWay}" />
                </TextBlock>
            </Grid>
        </Border>
    </Grid>
</UserControl>
