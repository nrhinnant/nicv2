<Window x:Class="WfpTrafficControl.UI.Views.PolicyHistoryView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:WfpTrafficControl.UI.ViewModels"
        xmlns:converters="clr-namespace:WfpTrafficControl.UI.Converters"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=vm:PolicyHistoryViewModel}"
        Title="Policy Version History"
        Height="600" Width="800"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource BackgroundBrush}">

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility" />
    </Window.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="Policy Version History"
                       FontSize="20"
                       FontWeight="SemiBold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />
            <TextBlock Text="View and revert to previous policy versions. Each time a policy is applied, it is automatically saved to history."
                       FontSize="12"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       TextWrapping="Wrap"
                       Margin="0,4,0,0" />
        </StackPanel>

        <!-- History List -->
        <Border Grid.Row="1" Style="{StaticResource CardStyle}" Padding="0">
            <Grid>
                <!-- List View -->
                <ListView ItemsSource="{Binding HistoryEntries}"
                          SelectedItem="{Binding SelectedEntry}"
                          BorderThickness="0"
                          Background="Transparent"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="Version" Width="80">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding PolicyVersion}"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource PrimaryBrush}" />
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Applied" Width="150">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding AppliedAt, StringFormat={}{0:yyyy-MM-dd HH:mm:ss}}"
                                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Rules" Width="60">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding RuleCount}"
                                                   HorizontalAlignment="Center"
                                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Source" Width="70">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Source}"
                                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Filters Created" Width="100">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding FiltersCreated}"
                                                   HorizontalAlignment="Center"
                                                   Foreground="{DynamicResource SuccessBrush}" />
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Filters Removed" Width="100">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding FiltersRemoved}"
                                                   HorizontalAlignment="Center"
                                                   Foreground="{DynamicResource ErrorBrush}" />
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Source Path" Width="200">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding SourcePath}"
                                                   TextTrimming="CharacterEllipsis"
                                                   ToolTip="{Binding SourcePath}"
                                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>

                <!-- Empty State -->
                <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Visibility="{Binding HistoryEntries.Count, Converter={StaticResource InverseBoolToVisibility}}">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HistoryEntries.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>
                    <TextBlock Text="No History Available"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,8" />
                    <TextBlock Text="Click Refresh to load history, or apply a policy to start tracking."
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               HorizontalAlignment="Center" />
                </StackPanel>

                <!-- Loading Overlay -->
                <Border Background="{DynamicResource BackgroundBrush}"
                        Opacity="0.9"
                        Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock Text="Loading..."
                                   FontSize="16"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Selected Entry Details -->
        <Border Grid.Row="2"
                Margin="0,16,0,0"
                Padding="16">
            <Border.Style>
                <Style TargetType="Border" BasedOn="{StaticResource CardStyle}">
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding SelectedEntry}" Value="{x:Null}">
                            <Setter Property="Visibility" Value="Collapsed" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Details -->
                <StackPanel Grid.Column="0">
                    <TextBlock FontSize="14" FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimaryBrush}">
                        <Run Text="Selected: Version " />
                        <Run Text="{Binding SelectedEntry.PolicyVersion, Mode=OneWay}"
                             Foreground="{DynamicResource PrimaryBrush}" />
                    </TextBlock>
                    <TextBlock FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               Margin="0,4,0,0">
                        <Run Text="Applied: " />
                        <Run Text="{Binding SelectedEntry.AppliedAt, Mode=OneWay, StringFormat={}{0:yyyy-MM-dd HH:mm:ss}}" />
                        <Run Text=" | " />
                        <Run Text="{Binding SelectedEntry.RuleCount, Mode=OneWay}" />
                        <Run Text=" rules | Source: " />
                        <Run Text="{Binding SelectedEntry.Source, Mode=OneWay}" />
                    </TextBlock>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="View Policy"
                            Style="{StaticResource SecondaryButtonStyle}"
                            Command="{Binding ViewSelectedPolicyCommand}"
                            IsEnabled="{Binding SelectedEntry, Converter={StaticResource BoolToVisibility}, ConverterParameter=NotNull}"
                            Padding="16,8"
                            Margin="0,0,8,0" />
                    <Button Content="Revert to This Version"
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding RevertToSelectedCommand}"
                            IsEnabled="{Binding CanRevert}"
                            Padding="16,8" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Footer -->
        <Grid Grid.Row="3" Margin="0,16,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Status Message -->
            <TextBlock Grid.Column="0"
                       Text="{Binding StatusMessage}"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource TextSecondaryBrush}" />

            <!-- Buttons -->
            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Content="Refresh"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Command="{Binding RefreshHistoryCommand}"
                        IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolToVisibility}}"
                        Padding="20,8"
                        Margin="0,0,8,0" />
                <Button Content="Close"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Click="CloseButton_Click"
                        Padding="20,8" />
            </StackPanel>
        </Grid>
    </Grid>
</Window>
